<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Revisar Cuestionarios - Panel Profesor</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="512x512" href="../favicon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="../favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../favicon.png">
  <link rel="apple-touch-icon" href="../favicon.png">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .btn-volver {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(255,255,255,0.95);
      color: #667eea;
      padding: 10px 20px;
      border-radius: 20px;
      text-decoration: none;
      font-weight: 600;
      z-index: 1000;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
    }

    .btn-volver:hover {
      background: #667eea;
      color: white;
      transform: translateY(-2px);
    }

    .container {
      max-width: 1400px;
      margin: 60px auto 40px;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
      padding-bottom: 30px;
      border-bottom: 3px solid #667eea;
    }

    .header h1 {
      color: #667eea;
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .header p {
      color: #666;
      font-size: 1.1em;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      border-left: 4px solid #667eea;
    }

    .stat-card .number {
      font-size: 2.5em;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 5px;
    }

    .stat-card .label {
      color: #666;
      font-size: 1em;
    }

    .filters {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 30px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filters select, .filters input {
      padding: 10px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
      background: white;
    }

    .filters select:focus, .filters input:focus {
      outline: none;
      border-color: #667eea;
    }

    .filters button {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 10px 25px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .filters button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .respuestas-list {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .respuesta-card {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 15px;
      padding: 25px;
      transition: all 0.3s ease;
    }

    .respuesta-card:hover {
      border-color: #667eea;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    .respuesta-card.revisado {
      border-left: 5px solid #28a745;
    }

    .respuesta-card.pendiente {
      border-left: 5px solid #ffc107;
    }

    .respuesta-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .alumno-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .alumno-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.5em;
      font-weight: bold;
    }

    .alumno-datos h3 {
      color: #333;
      margin-bottom: 5px;
    }

    .alumno-datos p {
      color: #666;
      font-size: 0.9em;
    }

    .badge {
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
    }

    .badge.pendiente {
      background: #fff3cd;
      color: #856404;
    }

    .badge.revisado {
      background: #d4edda;
      color: #155724;
    }

    .respuesta-content {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .pregunta-respuesta {
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e0e0e0;
    }

    .pregunta-respuesta:last-child {
      border-bottom: none;
    }

    .pregunta-titulo {
      font-weight: 600;
      color: #667eea;
      margin-bottom: 8px;
    }

    .respuesta-texto {
      color: #333;
      padding-left: 20px;
    }

    .acciones {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .btn-ver-detalles {
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-ver-detalles:hover {
      background: #5568d3;
      transform: translateY(-2px);
    }

    .btn-calificar {
      padding: 10px 20px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-calificar:hover {
      background: #218838;
      transform: translateY(-2px);
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #667eea;
      font-size: 1.2em;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .empty-state .icon {
      font-size: 4em;
      margin-bottom: 20px;
    }

    /* Modal para calificar */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 40px;
      border-radius: 20px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-content h2 {
      color: #667eea;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .form-group input, .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
    }

    .form-group input:focus, .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 25px;
    }

    .btn-cancelar {
      flex: 1;
      padding: 12px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    .btn-guardar {
      flex: 1;
      padding: 12px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <!-- Verificaci√≥n de autenticaci√≥n -->
  <script src="../auth-check.js"></script>

  <a href="../index.html" class="btn-volver">‚Üê Volver al Inicio</a>

  <div class="container">
    <div class="header">
      <h1>üë®‚Äçüè´ Panel de Revisi√≥n de Cuestionarios</h1>
      <p>Revisa y califica los cuestionarios enviados por tus alumnos</p>
    </div>

    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <div class="number" id="totalRespuestas">0</div>
        <div class="label">Total Enviados</div>
      </div>
      <div class="stat-card">
        <div class="number" id="pendientes">0</div>
        <div class="label">Pendientes</div>
      </div>
      <div class="stat-card">
        <div class="number" id="revisados">0</div>
        <div class="label">Revisados</div>
      </div>
      <div class="stat-card">
        <div class="number" id="notaPromedio">-</div>
        <div class="label">Nota Promedio</div>
      </div>
    </div>

    <div class="filters">
      <select id="filterEstado">
        <option value="todos">Todos</option>
        <option value="pendiente">Pendientes</option>
        <option value="revisado">Revisados</option>
      </select>
      
      <input type="text" id="filterAlumno" placeholder="Buscar por nombre de alumno...">
      
      <button onclick="cargarRespuestas()">üîç Filtrar</button>
      <button onclick="cargarRespuestas()">üîÑ Actualizar</button>
    </div>

    <div id="loadingState" class="loading">
      <div class="spinner"></div>
      <p>Cargando cuestionarios...</p>
    </div>

    <div id="respuestasList" class="respuestas-list" style="display: none;">
      <!-- Se llenar√°n din√°micamente -->
    </div>

    <div id="emptyState" class="empty-state" style="display: none;">
      <div class="icon">üìù</div>
      <h3>No hay cuestionarios enviados</h3>
      <p>Los cuestionarios enviados por los alumnos aparecer√°n aqu√≠</p>
    </div>
  </div>

  <!-- Modal para calificar -->
  <div id="modalCalificar" class="modal">
    <div class="modal-content">
      <h2>üìä Calificar Cuestionario</h2>
      <div class="form-group">
        <label>Alumno:</label>
        <input type="text" id="modalAlumno" readonly>
      </div>
      <div class="form-group">
        <label>Nota (sobre 20):</label>
        <input type="number" id="modalNota" min="0" max="20" step="0.5" placeholder="18.5">
      </div>
      <div class="form-group">
        <label>Comentarios:</label>
        <textarea id="modalComentarios" rows="5" placeholder="Escribe tus comentarios y retroalimentaci√≥n..."></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn-cancelar" onclick="cerrarModal()">Cancelar</button>
        <button class="btn-guardar" onclick="guardarCalificacion()">Guardar Calificaci√≥n</button>
      </div>
    </div>
  </div>

  <script>
    const API_URL = window.location.hostname === 'localhost' 
      ? 'http://localhost:3000'
      : 'https://clases1daw-production.up.railway.app';

    let respuestasActuales = [];
    let respuestaSeleccionada = null;

    // Cargar respuestas al iniciar
    window.addEventListener('DOMContentLoaded', () => {
      cargarRespuestas();
    });

    async function cargarRespuestas() {
      const loadingState = document.getElementById('loadingState');
      const respuestasList = document.getElementById('respuestasList');
      const emptyState = document.getElementById('emptyState');

      loadingState.style.display = 'block';
      respuestasList.style.display = 'none';
      emptyState.style.display = 'none';

      try {
        const token = localStorage.getItem('authToken');
        const headers = {};
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }
        
        const response = await fetch(`${API_URL}/api/cuestionario/respuestas/BD-CLASE1`, {
          headers: headers,
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error('Error al cargar respuestas');
        }

        const data = await response.json();
        
        if (data.success) {
          respuestasActuales = data.respuestas;
          
          if (respuestasActuales.length === 0) {
            loadingState.style.display = 'none';
            emptyState.style.display = 'block';
          } else {
            actualizarEstadisticas();
            renderizarRespuestas();
            loadingState.style.display = 'none';
            respuestasList.style.display = 'flex';
          }
        } else {
          throw new Error(data.message || 'Error al cargar respuestas');
        }
      } catch (error) {
        console.error('Error:', error);
        loadingState.innerHTML = `
          <div class="icon">‚ùå</div>
          <p style="color: #e74c3c;">Error al cargar los cuestionarios</p>
          <p style="font-size: 0.9em; color: #666;">Aseg√∫rate de estar conectado como profesor</p>
        `;
      }
    }

    function actualizarEstadisticas() {
      const total = respuestasActuales.length;
      const revisados = respuestasActuales.filter(r => r.revisado).length;
      const pendientes = total - revisados;
      
      const notasValidas = respuestasActuales.filter(r => r.nota != null).map(r => parseFloat(r.nota));
      const promedio = notasValidas.length > 0 
        ? (notasValidas.reduce((a, b) => a + b, 0) / notasValidas.length).toFixed(2)
        : '-';

      document.getElementById('totalRespuestas').textContent = total;
      document.getElementById('pendientes').textContent = pendientes;
      document.getElementById('revisados').textContent = revisados;
      document.getElementById('notaPromedio').textContent = promedio !== '-' ? promedio : '-';
    }

    function renderizarRespuestas() {
      const container = document.getElementById('respuestasList');
      const filterEstado = document.getElementById('filterEstado').value;
      const filterAlumno = document.getElementById('filterAlumno').value.toLowerCase();

      let respuestasFiltradas = respuestasActuales;

      // Filtrar por estado
      if (filterEstado === 'pendiente') {
        respuestasFiltradas = respuestasFiltradas.filter(r => !r.revisado);
      } else if (filterEstado === 'revisado') {
        respuestasFiltradas = respuestasFiltradas.filter(r => r.revisado);
      }

      // Filtrar por nombre de alumno
      if (filterAlumno) {
        respuestasFiltradas = respuestasFiltradas.filter(r => 
          r.nombre.toLowerCase().includes(filterAlumno) || 
          r.username.toLowerCase().includes(filterAlumno)
        );
      }

      if (respuestasFiltradas.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="icon">üîç</div><h3>No se encontraron resultados</h3></div>';
        return;
      }

      container.innerHTML = respuestasFiltradas.map(respuesta => {
        const inicial = respuesta.nombre.charAt(0).toUpperCase();
        const fecha = new Date(respuesta.fecha_envio).toLocaleString('es-ES');
        const estado = respuesta.revisado ? 'revisado' : 'pendiente';
        const estadoTexto = respuesta.revisado ? 'Revisado' : 'Pendiente';

        // Contar respuestas
        const totalPreguntas = Object.keys(respuesta.respuestas).length;

        return `
          <div class="respuesta-card ${estado}">
            <div class="respuesta-header">
              <div class="alumno-info">
                <div class="alumno-avatar">${inicial}</div>
                <div class="alumno-datos">
                  <h3>${respuesta.nombre}</h3>
                  <p>@${respuesta.username} ¬∑ ${fecha}</p>
                </div>
              </div>
              <div>
                <span class="badge ${estado}">${estadoTexto}</span>
                ${respuesta.nota ? `<p style="margin-top: 5px; font-weight: bold; color: #667eea;">Nota: ${respuesta.nota}/20</p>` : ''}
              </div>
            </div>

            <div class="respuesta-content">
              <p><strong>Total de preguntas respondidas:</strong> ${totalPreguntas}</p>
              <p><strong>Cuestionario:</strong> BD-CLASE1</p>
              ${respuesta.comentarios ? `<p style="margin-top: 10px;"><strong>Comentarios del profesor:</strong><br>${respuesta.comentarios}</p>` : ''}
            </div>

            <div class="acciones">
              <button class="btn-ver-detalles" onclick="verDetalles(${respuesta.respuesta_id})">
                üëÅÔ∏è Ver Respuestas Completas
              </button>
              <button class="btn-calificar" onclick="abrirModalCalificar(${respuesta.respuesta_id})">
                ${respuesta.revisado ? '‚úèÔ∏è Editar Calificaci√≥n' : 'üìä Calificar'}
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function verDetalles(respuestaId) {
      const respuesta = respuestasActuales.find(r => r.respuesta_id === respuestaId);
      if (!respuesta) return;

      // Crear ventana modal con todas las respuestas
      const respuestasObj = respuesta.respuestas;
      let contenidoHTML = '<div style="max-width: 800px; margin: 20px auto; background: white; padding: 30px; border-radius: 15px;">';
      contenidoHTML += `<h2 style="color: #667eea; margin-bottom: 20px;">Respuestas de ${respuesta.nombre}</h2>`;
      
      for (let [pregunta, respuestaTexto] of Object.entries(respuestasObj)) {
        contenidoHTML += `
          <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
            <p style="font-weight: bold; color: #667eea; margin-bottom: 10px;">${pregunta}</p>
            <p style="color: #333;">${respuestaTexto}</p>
          </div>
        `;
      }
      
      contenidoHTML += '<button onclick="window.close()" style="padding: 10px 30px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Cerrar</button>';
      contenidoHTML += '</div>';

      const ventana = window.open('', '_blank', 'width=900,height=700');
      ventana.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Respuestas - ${respuesta.nombre}</title>
          <style>
            body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; }
          </style>
        </head>
        <body>${contenidoHTML}</body>
        </html>
      `);
    }

    function abrirModalCalificar(respuestaId) {
      const respuesta = respuestasActuales.find(r => r.respuesta_id === respuestaId);
      if (!respuesta) return;

      respuestaSeleccionada = respuesta;
      
      document.getElementById('modalAlumno').value = `${respuesta.nombre} (@${respuesta.username})`;
      document.getElementById('modalNota').value = respuesta.nota || '';
      document.getElementById('modalComentarios').value = respuesta.comentarios || '';
      
      document.getElementById('modalCalificar').classList.add('show');
    }

    function cerrarModal() {
      document.getElementById('modalCalificar').classList.remove('show');
      respuestaSeleccionada = null;
    }

    async function guardarCalificacion() {
      if (!respuestaSeleccionada) return;

      const nota = parseFloat(document.getElementById('modalNota').value);
      const comentarios = document.getElementById('modalComentarios').value;

      if (isNaN(nota) || nota < 0 || nota > 20) {
        alert('Por favor, ingresa una nota v√°lida entre 0 y 20');
        return;
      }

      try {
        const token = localStorage.getItem('authToken');
        const headers = {
          'Content-Type': 'application/json'
        };
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }
        
        const response = await fetch(`${API_URL}/api/cuestionario/calificar`, {
          method: 'POST',
          headers: headers,
          credentials: 'include',
          body: JSON.stringify({
            respuesta_id: respuestaSeleccionada.respuesta_id,
            nota: nota,
            comentarios: comentarios
          })
        });

        const data = await response.json();

        if (data.success) {
          alert('‚úÖ Calificaci√≥n guardada correctamente');
          cerrarModal();
          cargarRespuestas();
        } else {
          alert('‚ùå Error al guardar la calificaci√≥n');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error de conexi√≥n');
      }
    }
  </script>
</body>
</html>
